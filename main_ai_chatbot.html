<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Assistant - Happy Dairy Farm</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden; /* Prevent body scroll */
            /* --- Reverted BACK TO BACKGROUND IMAGE --- */
            background-image: url('https://images.pexels.com/photos/422202/pexels-photo-422202.jpeg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed; /* Keep background fixed during scroll */
        }
        .chatbot-messages::-webkit-scrollbar { width: 8px; }
        .chatbot-messages::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.1); border-radius: 10px;}
        .chatbot-messages::-webkit-scrollbar-thumb { background: rgba(0, 0, 0, 0.3); border-radius: 10px; border: 2px solid transparent; background-clip: content-box;}
        .chatbot-messages::-webkit-scrollbar-thumb:hover { background: rgba(0, 0, 0, 0.4); }


        /* Message Entry Animation */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .message-entry {
            animation: fadeIn 0.3s ease-out;
        }

        /* Typing Indicator Dots */
        .typing-dot {
            width: 8px; height: 8px; background-color: #9ca3af; /* gray-400 */
            border-radius: 50%; display: inline-block;
        }

        /* Ensure input doesn't overlap scrollbar */
         #chatbot-messages {
             padding-right: 1rem; /* Add padding for scrollbar */
         }

         /* Basic list styling within messages */
        .message-content ul, .message-content ol {
            padding-left: 2rem; /* Indent lists */
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
        }
         .message-content ul {
            list-style-type: disc;
         }
         .message-content ol {
             list-style-type: decimal;
         }
         .message-content li {
            margin-bottom: 0.25rem;
         }
         
         /* Slightly darker error messages (Using Tailwind now) */


    </style>
</head>
<body class="bg-gray-100">

    <!-- Removed Bubble Background Container -->

    <!-- Main Full-Page Container - Background applied directly to body -->
    <div class="w-full h-screen flex flex-col"> 
        
        <!-- Header -->
        <div class="p-4 text-white flex justify-between items-center bg-black/50 shadow-lg border-b border-white/10"> 
            <div class="flex items-center gap-4">
                <!-- Bot Icon -->
                 <div class="bg-gradient-to-br from-green-400 to-green-600 text-white p-2 rounded-full h-10 w-10 flex items-center justify-center flex-shrink-0 shadow-md">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                         <path stroke-linecap="round" stroke-linejoin="round" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
                     </svg>
                 </div>
                <div>
                    <h2 class="text-xl font-semibold tracking-wide">AI Assistant</h2>
                    <p class="text-sm opacity-90 flex items-center gap-1.5">
                        <span class="h-2 w-2 bg-green-400 rounded-full inline-block animate-pulse"></span>
                        Online
                    </p>
                </div>
            </div>
            <!-- Link back to your main website -->
            <a href="./index.html" class="text-white bg-white/10 hover:bg-white/20 transition-colors rounded-lg py-2 px-4 focus:outline-none focus:ring-2 focus:ring-white/50 text-sm font-medium flex items-center gap-2">
                 <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                   <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                 </svg>
                Back to Farm
            </a>
        </div>

        <!-- Messages -->
        <div id="chatbot-messages" class="flex-1 p-6 overflow-y-auto chatbot-messages space-y-6">
             <!-- Initial Greeting -->
            <div class="flex items-start gap-3 message-entry">
                <div class="bg-gradient-to-br from-green-400 to-green-600 text-white p-2 rounded-full h-9 w-9 flex items-center justify-center flex-shrink-0 shadow-md">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                         <path stroke-linecap="round" stroke-linejoin="round" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
                     </svg>
                </div>
                <!-- Bot message bubble - Increased opacity -->
                <div class="bg-gray-100/80 text-gray-900 p-4 rounded-2xl rounded-tl-none shadow-md max-w-lg message-content"> 
                    <p class="text-base">Hello! I'm the AI assistant for Happy Dairy Farm. How can I assist you today?</p>
                </div>
            </div>
        </div>

        <!-- Input -->
        <div class="p-4 border-t border-white/10 bg-black/50"> 
            <form id="chat-form" class="flex items-center gap-3 max-w-4xl mx-auto">
                <input type="text" id="user-input" class="w-full px-5 py-3 border-none rounded-full focus:outline-none focus:ring-2 focus:ring-green-400 transition bg-white text-gray-900 placeholder-gray-500 text-base shadow-inner" placeholder="Ask anything about our farm..." autocomplete="off">
                 <!-- Send Button -->
                <button type="submit" id="send-button" class="bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-semibold p-3 rounded-full transition-all transform hover:scale-110 focus:outline-none focus:ring-2 focus:ring-green-400 focus:ring-offset-2 focus:ring-offset-black/30 flex-shrink-0 shadow-md">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" /></svg>
                </button>
            </form>
        </div>
    </div>

    <script>
        // --- DOM Elements ---
        const chatForm = document.getElementById('chat-form');
        const userInput = document.getElementById('user-input');
        const chatMessages = document.getElementById('chatbot-messages');
        const sendButton = document.getElementById('send-button');

        // --- API & Conversation Logic (MODIFIED FOR OPENROUTER) ---
        const API_KEY = "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"; // API Key
        const API_URL = `https://openrouter.ai/api/v1/chat/completions`;
        const SYSTEM_PROMPT = "You are a friendly and helpful AI assistant for the Happy Dairy Farm website. Your goal is to answer user questions about dairy products, the farm, and guide users. Use Markdown formatting like lists (* item) or numbered lists (1. item) when appropriate for clarity. Keep your responses concise, clear, and professional. If you don't know the answer, say that you don't have that information.";
        
        // Initial message is already in HTML, so no need to include it here initially
        let conversationHistory = []; 

        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const userMessage = userInput.value.trim();
            if (!userMessage) return;

            addMessage(userMessage, 'user');
            // Add user message to history *after* displaying
            conversationHistory.push({ role: "user", parts: [{ text: userMessage }] });
            
            userInput.value = '';
            userInput.disabled = true;
            sendButton.disabled = true;
            sendButton.classList.add('opacity-50', 'cursor-not-allowed');
            showTypingIndicator();

            try {
                const response = await callOpenRouterApi();
                removeTypingIndicator();
                addMessage(response, 'bot');
                 // Add bot message to history *after* displaying
                conversationHistory.push({ role: "model", parts: [{ text: response }] });
            } catch (error) {
                console.error('Full API Error:', error);
                removeTypingIndicator();
                // Check for specific 'User not found' error and provide a better hint
                let errorMessage = `Oops! ${error.message}. Please try again.`;
                if (error.message.includes("User not found")) {
                    errorMessage = "Oops! There seems to be an issue connecting to the AI. Please double-check if the API key used is correct and active on OpenRouter.";
                }
                addMessage(errorMessage, 'bot', true); // Indicate error
            } finally {
                userInput.disabled = false;
                sendButton.disabled = false;
                sendButton.classList.remove('opacity-50', 'cursor-not-allowed');
                userInput.focus();
            }
        });
        
        async function callOpenRouterApi() {
            if (!API_KEY || API_KEY === "PASTE_YOUR_OPENROUTER_KEY_HERE") {
                throw new Error("API Key configuration error.");
            }

            // Map history for the API call
            const apiMessages = conversationHistory.map(turn => ({
                role: turn.role === 'model' ? 'assistant' : 'user',
                content: turn.parts[0].text
            }));

            const payload = {
                model: "deepseek/deepseek-chat", 
                messages: [
                    { role: "system", content: SYSTEM_PROMPT },
                    ...apiMessages // Include mapped history
                ]
            };
            
            // Note: HTTP-Referer might cause issues in some environments. 
            // If errors persist, try removing the 'HTTP-Referer' line.
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${API_KEY}`,
                    'Content-Type': 'application/json',
                    'HTTP-Referer': `${location.protocol}//${location.host}`, 
                    'X-Title': 'Happy Dairy Farm Chatbot',
                },
                body: JSON.stringify(payload)
            });

            const result = await response.json();

            if (!response.ok) {
                const errorDetails = result?.error?.message || `API request failed with status ${response.status}`;
                throw new Error(errorDetails); // Throw the error message from the API response
            }
            
            const choice = result.choices?.[0];
            return choice?.message?.content || "I couldn't generate a response. Please try again.";
        }

        // --- Function to convert simple Markdown lists to HTML ---
        function simpleMarkdownToHtml(text) {
             let html = text
                 // Escape basic HTML tags first to prevent injection from markdown content
                 .replace(/</g, "&lt;")
                 .replace(/>/g, "&gt;")
                 // Bold: **text** or __text__
                 .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                 .replace(/__(.*?)__/g, '<strong>$1</strong>')
                 // Italic: *text* or _text_
                 .replace(/(?<!\*)\*(?!\*)(.*?)(?<!\*)\*(?!\*)/g, '<em>$1</em>') // Match single * but not **
                 .replace(/(?<!_)_(?!_)(.*?)(?<!_)_(?!_)/g, '<em>$1</em>')   // Match single _ but not __
                 // Convert lines starting with * or - into <li> items
                 .replace(/^\s*[\*\-]\s+(.*)$/gm, '<li>$1</li>')
                 // Convert lines starting with 1., 2., etc. into <li> items
                 .replace(/^\s*(\d+)\.\s+(.*)$/gm, '<li>$2</li>') // Capture number but don't use it directly for basic HTML
                 // Wrap consecutive <li> items generated from * or - into <ul>
                 .replace(/(<li>.*<\/li>\s*)+/g, (match) => {
                     // Only wrap if not already inside a list
                     if (!match.trim().startsWith('<ul>') && !match.trim().startsWith('<ol>')) {
                         // Check if the original markdown line started with a digit+dot to try and detect <ol>
                         // This simple regex check is basic and might not cover all edge cases
                         const originalLineMightBeOrdered = /^\s*\d+\./.test(text.split('\n').find(line => line.includes(match.replace(/<[^>]*>/g,'').trim())) || ''); 
                         const listTag = originalLineMightBeOrdered ? 'ol' : 'ul';
                         return `<${listTag}>${match.replace(/\n/g, '')}</${listTag}>`; // Remove extra newlines within the match
                     }
                     return match;
                 })
                 // Convert double newlines between blocks into paragraph breaks
                 .replace(/\n\n/g, '</p><p>')
                  // Convert single newlines within potential paragraphs to <br>, unless it's around list tags
                 .replace(/([^\n])\n(?!\s*(?:<\/?(?:ul|ol|li)>))/g, '$1<br>');

             // Wrap the entire processed text in <p> tags if it doesn't start with a list or existing paragraph
             if (!html.trim().startsWith('<p>') && !html.trim().startsWith('<ul>') && !html.trim().startsWith('<ol>')) {
                 html = `<p>${html}</p>`;
             }
             // Remove empty paragraphs possibly created by multiple newlines
             html = html.replace(/<p><\/p>/g, '');
             // Clean up potential <br> tags at the beginning/end of paragraphs or list items
             html = html.replace(/<p><br>/g, '<p>').replace(/<br><\/p>/g, '</p>');
             html = html.replace(/<li><br>/g, '<li>').replace(/<br><\/li>/g, '</li>');

             return html;
        }


        function addMessage(message, sender, isError = false) {
            const messageWrapper = document.createElement('div');
            messageWrapper.className = 'message-entry'; // For animation

            // Use innerHTML and parse Markdown for bot messages
            const formattedMessage = (sender === 'bot') ? simpleMarkdownToHtml(message) : `<p class="text-base">${message}</p>`; // User messages as plain text paragraph

            if (sender === 'user') {
                messageWrapper.className += ' flex items-start gap-3 mb-6 justify-end';
                messageWrapper.innerHTML = `
                    <!-- User Message Bubble - Increased opacity -->
                    <div class="bg-gradient-to-r from-green-500/75 to-green-600/75 text-white p-4 rounded-2xl rounded-tr-none shadow-md max-w-lg message-content"> 
                        ${formattedMessage} 
                    </div>
                    <div class="bg-gray-200 text-gray-700 p-2 rounded-full h-9 w-9 flex items-center justify-center flex-shrink-0 shadow-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                        </svg>
                    </div>`;
            } else { // Bot or Error message
                messageWrapper.className += ' flex items-start gap-3 mb-6';
                // Define classes using Tailwind opacity modifiers - Increased opacity
                const bgColor = isError ? 'bg-red-100/80' : 'bg-gray-100/80'; 
                const textColor = isError ? 'text-red-900' : 'text-gray-900'; // Darker text for better contrast
                const iconBg = isError ? 'bg-red-500' : 'bg-gradient-to-br from-green-400 to-green-600'; // Bot Icon

                messageWrapper.innerHTML = `
                    <div class="${iconBg} text-white p-2 rounded-full h-9 w-9 flex items-center justify-center flex-shrink-0 shadow-md">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            ${isError ? '<path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />' : '<path stroke-linecap="round" stroke-linejoin="round" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />'}
                        </svg>
                    </div>
                    <div class="${bgColor} ${textColor} p-4 rounded-2xl rounded-tl-none shadow-md max-w-lg message-content">
                         ${formattedMessage}
                    </div>`;
            }
            chatMessages.appendChild(messageWrapper);
            // Smooth scroll to the bottom
            chatMessages.scrollTo({ top: chatMessages.scrollHeight, behavior: 'smooth' });
        }

        function showTypingIndicator() {
            const typingIndicator = document.createElement('div');
            typingIndicator.id = 'typing-indicator';
            typingIndicator.className = 'flex items-start gap-3 mb-6 message-entry'; // Added animation class
            typingIndicator.innerHTML = `
                <div class="bg-gradient-to-br from-green-400 to-green-600 text-white p-2 rounded-full h-9 w-9 flex items-center justify-center flex-shrink-0 shadow-md">
                   <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                       <path stroke-linecap="round" stroke-linejoin="round" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
                   </svg>
                </div>
                <!-- Typing indicator bubble - Increased opacity -->
                <div class="bg-gray-100/80 text-gray-900 p-4 rounded-2xl rounded-tl-none shadow-md max-w-md flex items-center space-x-2"> 
                    <span class="typing-dot animate-bounce"></span>
                    <span class="typing-dot animate-bounce" style="animation-delay: 0.15s;"></span>
                    <span class="typing-dot animate-bounce" style="animation-delay: 0.3s;"></span>
                </div>`;
            chatMessages.appendChild(typingIndicator);
             // Smooth scroll to the bottom
            chatMessages.scrollTo({ top: chatMessages.scrollHeight, behavior: 'smooth' });
        }

        function removeTypingIndicator() {
            const typingIndicator = document.getElementById('typing-indicator');
            if (typingIndicator) typingIndicator.remove();
        }

        // Initial focus on input
        userInput.focus();
    </script>
</body>
</html>

